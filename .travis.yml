# N.B. The tokens GH_TOKEN and GITHUBTOKEN are set in the Travis setup panel
# not encrypted into this file.

language: java

jdk:
- oraclejdk8

branches:
  only:
  - master
  - travis
  - "/^release.*/"

env:
  global:
  - CLASSPATH=/usr/share/java/xalan-j2.jar:/usr/share/java/xercesImpl.jar:/usr/share/java/xml-resolver.jar:$(pwd)/.travis

install:
- sudo apt-get update -q
- sudo apt-get install xsltproc
- sudo apt-get install libxml-xpath-perl
- sudo apt-get install libsaxon-java libxml-commons-resolver1.1-java libsaxon-java
  libxerces2-java
- sudo apt-get install trang
- sudo apt-get install imagemagick
- sudo apt-get install dblatex
- cp .travis/xmlc ~/.xmlc

script:
- make
- make check
- make dist
- export VERSION=$(make version)

after_success:
- |
  if [ "$TRAVIS_REPO_SLUG" = "docbook/xslt10-stylesheets" -a \
       "$TRAVIS_PULL_REQUEST" = "false" ]; then
    export GH_TOKEN
    .travis/publish-release.sh
  fi

before_deploy:
- git config --global user.email "builds@travis-ci.com"
- git config --global user.name "Travis CI"
- export GIT_TAG=snapshot/$(date -u "+%Y-%m-%d")-$TRAVIS_BUILD_NUMBER
- git tag $GIT_TAG -a -m "Generated tag from TravisCI build $TRAVIS_BUILD_NUMBER"
- git push https://$GITHUBTOKEN@github.com/docbook/xslt10-stylesheets $GIT_TAG

notifications:
  email:
    on_success: change
    on_failure: change
  irc:
    channels:
    - chat.freenode.net#docbook

deploy:
  provider: releases
  prerelease: true
  api_key:
    secure: C3XlJYP4Fr5bkZRTZWAEZiAi4FxxFWE8oWTwYEH0aBj5Duc+l/M4WUWlI7kuRvf4nJVYjJ4Ano55M6KGlXU1Nqrkzza/y9MFdWvvlDROhgwftmf4kiVBKSu/Db13jipne7hDu7N32aBA6jhS6f8hTUTYXrp1aojeY04czrBtzKjAvWjwBpZlPMhaQcxxg1ta18dLA2oo+k6XvNXIvZBVxumk6LlGWNmXPig5KTyntRJtFak5MplyPEQ6hYIq5HFS5nY3WOMIPW+io0mmr1ESr//98Z9Q6N0Pr5PCQadF0eOOlSYkY3ggEKT7v+g+uFrGnUHXnhcWmydy798RRr/ixbMd5jVtOWIRuGp7oQud1P2oY0ICPiF6S0a24alpELpnjGtqnZ4RH2jNQZhRgD71466Og5ZSsN09+HzXghY0KSUw65emgZGYN6LU0NgL+13PIje5Ow2E236wkDmlnxIkXvpr/UAQlyXR6QWHSG2gzgSn4zoHSHWRDc/5Jhgd0WDEnMV5U1SnC8w/bObjTvNhtIkXTDdMWLGQDR5Me4qg4IT0FtnpMai3aOvnRyMyfNy/yAY5jEX8bBwVDwXYxxIUz2O88zyxTWgZVM2OvUeVi9xKjtfskp9pwFs3xEB+Q8T8HFYAKmcVxxsW9U2C1Zy6Q2eKDrjXx/bn/27GecQa26k=
  file:
  - dist/docbook-xsl-$VERSION.tar.bz2
  - dist/docbook-xsl-$VERSION.tar.gz
  - dist/docbook-xsl-$VERSION.zip
  - dist/docbook-xsl-nons-$VERSION.tar.bz2
  - dist/docbook-xsl-nons-$VERSION.tar.gz
  - dist/docbook-xsl-nons-$VERSION.zip
  - dist/docbook-xsl-doc-$VERSION.tar.bz2
  - dist/docbook-xsl-doc-$VERSION.tar.gz
  - dist/docbook-xsl-doc-$VERSION.zip
  on:
    repo: docbook/xslt10-stylesheets
    branch: master
