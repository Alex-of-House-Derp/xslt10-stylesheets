# N.B. The tokens GH_TOKEN and GITHUBTOKEN are set in the Travis setup panel
# not encrypted into this file.

language: java

jdk:
- oraclejdk8

branches:
  only:
  - master
  - travis
  - "/^release.*/"

env:
  global:
  - CLASSPATH=/usr/share/java/xalan-j2.jar:/usr/share/java/xercesImpl.jar:/usr/share/java/xml-resolver.jar:$(pwd)/.travis

install:
- sudo apt-get update -q
- sudo apt-get install xsltproc
- sudo apt-get install libxml-xpath-perl
- sudo apt-get install libsaxon-java libxml-commons-resolver1.1-java libsaxon-java
  libxerces2-java
- sudo apt-get install trang
- sudo apt-get install imagemagick
- sudo apt-get install dblatex
- cp .travis/xmlc ~/.xmlc

script:
- make
- make check
- make dist
- export VERSION=$(make version)

after_success:
- |
  if [ "$TRAVIS_REPO_SLUG" = "docbook/xslt10-stylesheets" -a \
       "$TRAVIS_PULL_REQUEST" = "false" ]; then
    export GH_TOKEN
    .travis/publish-release.sh
  fi

before_deploy:
- git config --global user.email "builds@travis-ci.com"
- git config --global user.name "Travis CI"
- export GIT_TAG=snapshot/$(date -u "+%Y-%m-%d")-$TRAVIS_BUILD_NUMBER
- git tag $GIT_TAG -a -m "Generated tag from TravisCI build $TRAVIS_BUILD_NUMBER"
- git push https://$GITHUBTOKEN@github.com/docbook/xslt10-stylesheets $GIT_TAG

deploy:
  provider: releases
  prerelease: true
  api_key:
    secure: YG6AK8dVvCoDayk2LAw9XUqUyPs1yBRQMjPsyegXiyrAOZb7dvgaDDhiB99nL/CokqUHVk/DwKlAGsMMUuY67iBaXg8puByGAd4CmFi8OGNhzEv+kdmqst6xk9MVcnIepWruYjZa9C8isy9Sk0s0zMKS6JMJEOnnYveFCQWZazZziz//N+77VPyyMqDksn8vJqdTM6h5H6rw39oiYGoWGuiNxT5wd05FenuIs8YtuE4IQn/vyx8xcmFk54FZ50MyXNAbB3GJoqlLYQgLmoI+04CgyljAOlIn+KfW3/+FDVQlIAKY5K1Eu4YQkloMeRCkTpEux6wpsbkN1nevbpw8IANYRckag6WJZNQ7xOZvwSpHSoBMfir66lJty1ANzYmvJS0uMkEJK2io8MZ3JoPdk7iJEYJdFr1mM7F6qq14eB93VrZZuG+E7/r6SPahLKYRxkLM3LqQ8FMnBg4q+x8+cG/F0ad+icffgOQ/LoC+OdgHYQlHaRWO7DwNKkxSjCi3OKnKfRLEEMzcxignkx4qu3ybi7h1J+F0wegFPfNeaG/dkVj0nDYV7QF5kskCZ6yBK18slN6oSnwaxSmnCACN0FdVcpoHttHkkQf2I01iEcskWOgT2WBlup2do4Yzv9tlZcCJ4QeX4ozfPPcisnNK7Cpc5uY7X0wWJbAyVw88kX8=
  file:
  - dist/docbook-xsl-$VERSION.tar.bz2
  - dist/docbook-xsl-$VERSION.tar.gz
  - dist/docbook-xsl-$VERSION.zip
  - dist/docbook-xsl-nons-$VERSION.tar.bz2
  - dist/docbook-xsl-nons-$VERSION.tar.gz
  - dist/docbook-xsl-nons-$VERSION.zip
  - dist/docbook-xsl-doc-$VERSION.tar.bz2
  - dist/docbook-xsl-doc-$VERSION.tar.gz
  - dist/docbook-xsl-doc-$VERSION.zip
  on:
    repo: docbook/xslt10-stylesheets
    branch: master

notifications:
  email:
    on_success: change
    on_failure: change
  irc:
    channels:
    - chat.freenode.net#docbook
